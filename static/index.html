<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/index.css" />
    <link rel="icon" href="data:,">
    <title>Latte</title>
</head>

<body>
    <main>
        <div class="page-container">
            <div class="page active"></div>
            <div class="page"></div>
            <div class="page"></div>
            <div class="page"></div>
        </div>
        <div class="icon-container">
            <div class="box" id="0">
                <img src="/static/files/Mother_1.png" />
            </div>
            <div class="box" id="1">
                <img src="/static/files/Mother 2.png" />
            </div>
            <div class="box" id="2"></div>
            <div class="box" id="3"></div>
            <div class="box" id="4"></div>
            <div class="box" id="5"></div>
            <div class="box" id="6">
                <img src="/static/files/Mother 3.png" />
            </div>
            <div class="box" id="7"></div>
            <div class="box" id="8"></div>
            <div class="box" id="9"></div>
            <div class="box" id="10"></div>
            <div class="box" id="11"></div>
            <div class="box" id="12"></div>
            <div class="box" id="13"></div>
            <div class="box" id="14"></div>
        </div>

        <div id="cursor" class="cursor" src="/files/Cursor.png"></div>
    </main>
    <script>
        let cursorX = 0;
        let cursorY = 0;
        let active = 0;
        let gamepadId = null;

        const holdMap = new Map();
        const pressMap = new Map();

        const DPADUP = 12;
        const DPADDOWN = 13;
        const DPADLEFT = 14;
        const DPADRIGHT = 15;
        const FACEA = 0;

        function resetActiveScale() {
            const el = document.getElementById(active);
            el.style.scale = "1";
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function playMoveSoundEffect() {
            var rand = getRandomInt(1, 2);
            var sound = new Audio(`/static/move${rand}.mp3`);
            sound.volume = 0.5;
            sound.play();
        }

        function setCursorPositionToActive() {
            active = cursorY * 5 + cursorX;
            const el = document.getElementById(active);
            const rect = el.getBoundingClientRect();

            const cursor = document.getElementById("cursor");
            cursor.style.left = `${rect.left}px`;
            cursor.style.top = `${rect.top}px`;
            cursor.style.right = `${rect.right}px`;
            cursor.style.bottom = `${rect.bottom}px`;
            cursor.style.scale = "1.05";

            el.style.scale = "1.05";
        }

        function isButtonPressed(button) {
            const hold = holdMap.get(button);
            const press = pressMap.get(button);

            if (hold == true) {
                if (press == undefined || press == false) {
                    pressMap.set(button, true);
                    return true;
                }
            }
            return false;
        }

        function moveActiveLeft() {
            resetActiveScale();
            cursorX = ((cursorX - 1) % 5 + 5) % 5;
            setCursorPositionToActive();
            playMoveSoundEffect();
        }

        function moveActiveDown() {
            resetActiveScale();
            cursorY = ((cursorY + 1) % 3 + 3) % 3;
            setCursorPositionToActive();
            playMoveSoundEffect();
        }

        function moveActiveRight() {
            resetActiveScale();
            cursorX = ((cursorX + 1) % 5 + 5) % 5;
            setCursorPositionToActive();
            playMoveSoundEffect();
        }

        function moveActiveUp() {
            resetActiveScale();
            cursorY = ((cursorY - 1) % 3 + 3) % 3;
            setCursorPositionToActive();
            playMoveSoundEffect();
        }


        function gamepadLoop() {
            const gamepads = navigator.getGamepads();
            const gp = gamepads[0];

            for (i = 0; i < 17; i++) {
                holdMap.set(i, gp.buttons[i].pressed);

                if (!gp.buttons[i].pressed) {
                    pressMap.set(i, false);
                }
            }

            if (isButtonPressed(DPADRIGHT)) {
                moveActiveRight();
            }

            if (isButtonPressed(DPADLEFT)) {
                moveActiveLeft();
            }

            if (isButtonPressed(DPADDOWN)) {
                moveActiveDown();
            }

            if (isButtonPressed(DPADUP)) {
                moveActiveUp();
            }

            if (isButtonPressed(FACEA)) {
                window.location.href = "/nes?rom=rom.nes"
            }

            start = requestAnimationFrame(gamepadLoop);
        }


        window.onload = () => {
            setCursorPositionToActive();
        }

        window.addEventListener("keypress", (ev) => {
            switch (ev.key) {
                case "a":
                    moveActiveLeft();
                    break;
                case "d":
                    moveActiveRight();
                    break;
                case "w":
                    moveActiveUp();
                    break;
                case "s":
                    moveActiveDown();
                    break;
            }
        })

        window.addEventListener("gamepadconnected", (ev) => {
            console.log(`Gamepad is now connected: ${ev.gamepad.id}`);
            gamepadId = ev.gamepad.id;

            gamepadLoop(ev.gamepad)
        })

        window.onresize = () => {
            resetActiveScale();
            setCursorPositionToActive();
        }

    </script>
</body>

</html>