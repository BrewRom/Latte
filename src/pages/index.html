<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style" />
    <link rel="icon" href="data:,">
    <title>Latte</title>
</head>
<body>
    <main>
        <div class="page-container">
            <div class="page active"></div>
            <div class="page"></div>
            <div class="page"></div>
            <div class="page"></div>
        </div>
        <div class="icon-container">
            <div class="box" id="0">
                <img src="/files/Mother_1.png" />
            </div>
            <div class="box" id="1">
                <img src="/files/Mother 2.png" />
            </div>
            <div class="box" id="2"></div>
            <div class="box" id="3"></div>
            <div class="box" id="4"></div>
            <div class="box" id="5"></div>
            <div class="box" id="6">
                <img src="/files/Mother 3.png" />
            </div>
            <div class="box" id="7"></div>
            <div class="box" id="8"></div>
            <div class="box" id="9"></div>
            <div class="box" id="10"></div>
            <div class="box" id="11"></div>
            <div class="box" id="12"></div>
            <div class="box" id="13"></div>
            <div class="box" id="14"></div>
        </div>
        
        <div id="cursor" class="cursor" src="/files/Cursor.png"></div>
    </main>
    <script>
        let active = 0;
        let gamepadId = null;

        const holdMap = new Map();
        const pressMap = new Map();

        const DPADUP = 12;
        const DPADDOWN = 13;
        const DPADLEFT = 14;
        const DPADRIGHT = 15;
        const FACEA = 0;
        
        function resetActiveScale() {
            const el = document.getElementById(active);
            el.style.scale = "1";
        }
        
        function setCursorPositionToActive() {
            const el = document.getElementById(active);
            const rect = el.getBoundingClientRect();

            const cursor = document.getElementById("cursor");
            cursor.style.left = `${rect.left}px`;
            cursor.style.top = `${rect.top}px`;
            cursor.style.right = `${rect.right}px`;
            cursor.style.bottom = `${rect.bottom}px`;
            cursor.style.scale = "1.05";

            el.style.scale = "1.05";
        }

        function isButtonPressed(button) {
            const hold = holdMap.get(button);
            const press = pressMap.get(button);

            if (hold == true) {
                if (press == undefined || press == false) {
                    pressMap.set(button, true);
                    return true;
                }
            }
            return false;
        }

        
        function gamepadLoop() {
            const gamepads = navigator.getGamepads();
            const gp = gamepads[0];

            for (i = 0; i < 17; i++) {
                holdMap.set(i, gp.buttons[i].pressed);

                if (!gp.buttons[i].pressed) {
                    pressMap.set(i, false);
                }
            }

            if (isButtonPressed(DPADRIGHT)) {
                if (active % 5 != 4) {
                    resetActiveScale();
                    active += 1;
                    setCursorPositionToActive();
                }
            }

            if (isButtonPressed(DPADLEFT)) {
                if (active % 5 != 0) {
                    resetActiveScale();
                    active -= 1;
                    setCursorPositionToActive();
                }
            }

            if (isButtonPressed(DPADDOWN)) {
                if (active % 15 != 10) {
                    resetActiveScale();
                    active += 5;
                    setCursorPositionToActive();
                }
            }

            if (isButtonPressed(DPADUP)) {
                if (active % 15 != 0) {
                    resetActiveScale();
                    active -= 5;
                    setCursorPositionToActive();
                }
            }

            if (isButtonPressed(FACEA)) {
                window.location.href="/nes?rom=rom.nes"
            }

            start = requestAnimationFrame(gamepadLoop);
        }


        window.onload = () => {
            console.log("Loaded")
            setCursorPositionToActive();
        }
        
        window.addEventListener("gamepadconnected", (ev) => {
            console.log(`Gamepad is now connected: ${ev.gamepad.id}`);
            gamepadId = ev.gamepad.id;

            gamepadLoop(ev.gamepad)
        })

        window.onresize = () => {
            resetActiveScale();
            setCursorPositionToActive();
        }
        
    </script>
</body>
</html>